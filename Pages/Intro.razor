@page "/"
@inherits MainLayout
@inject Game Game
@inject NavigationManager Navigation

<PageTitle>Tournament Fighter</PageTitle>

@if (enabledMusic)
{
    <!--<audio id="menu" autoplay src="@menuMusicSrc"></audio>-->
}

@if (pressedStart)
{
    <EditForm class="intro col-start" EditContext=@editContext Model=@Player OnValidSubmit=@Submit>
        <DataAnnotationsValidator></DataAnnotationsValidator>
        <div class="f-large h-15 row-center">
            <p>Your name is &nbsp;</p>
            <div class="f-largeAll text-input">
                <!--<ValidationMessage For="() => Player.Name"></ValidationMessage>-->
                <InputText tabindex="1" placeholder="type here..."
                           @bind-Value=@Player.Name @ref="nameInput"></InputText>
            </div>
            @{
                enteredName = enteredTagline = !String.IsNullOrWhiteSpace(Player.Name);
            }
        </div>
        @if (enteredName)
        {
            <p class="f-medium h-10">and you've entered a fighting tournament.</p>

            <div class="f-medium h-20 row-center">
                <p>You want people to call you the &nbsp</p>
                <div class="f-mediumAll text-input">
                    <!--<ValidationMessage For="() => Player.Tagline"></ValidationMessage>-->
                    <InputText tabindex="2" placeholder="type here..."
                               @bind-Value=@Player.Tagline @ref="taglineInput"></InputText>
                </div>
                @{
                    enteredTagline = !String.IsNullOrWhiteSpace(Player.Tagline);
                }
            </div>
        }
        @if (enteredTagline)
        {
            <p class="f-medium h-15">You will be facing 3 opponents. Defeat all three and you'll win prize money and fame!</p>
            <div class="f-large h-20 col-start">
                <p>You've been training hard, and your fighting style is:</p>
                <div class="row-center">
                    <button class="@(build == "bal" ? "btn-radio-active" : "") btn-radio f-medium" type="button" @onclick=@SetBalancedBuild>Balanced</button>
                    <button class="@(build == "agi" ? "btn-radio-active" : "") btn-radio f-medium" type="button" @onclick=@SetAgileBuild>Agile</button>
                    <button class="@(build == "tnk" ? "btn-radio-active" : "") btn-radio f-medium" type="button" @onclick=@SetTankyBuild>Tanky</button>
                    <button class="btn-gold f-medium" type="submit" disabled="@(!choseBuild)">Submit</button>
                </div>
            </div>
        }
    </EditForm>
}
else
{
    <span>
        <h1 class="logo">TOURNAMENT</h1>
        <h1 class="logo logo-bottom">FIGHTER</h1>
    </span>
    <button id="start-btn" class="btn-gold f-small" @onclick=@StartIntro>Start</button>
}

@code {
    private Character Player = new Character();

    private InputText nameInput;
    private InputText taglineInput;

    private EditContext? editContext { get; set; }
    private bool pressedStart = false;
    private bool enteredName = false;
    private bool enteredTagline = false;
    private bool choseBuild = false;
    private string build = "";

    private bool enabledMusic = false;
    private string menuMusicSrc = "media/menu.wav";

    private int maxNameLength = 20;
    private int maxTaglineLength = 20;

    [CascadingParameter] public MainLayout Layout { get; set; }

    protected override void OnInitialized()
    {
        Layout.ToggleLogo(false);
        Layout.DisableMenu();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (pressedStart)
        {
            if (!enteredName)
            {
                editContext?.Validate();
                if (nameInput.Element.HasValue)
                {
                    await nameInput.Element.Value.FocusAsync();
                }
            }
            else if (!enteredTagline)
            {
                if (taglineInput.Element.HasValue)
                {
                    await taglineInput.Element.Value.FocusAsync();
                }
            }
        }
    }

    private void StartIntro()
    {
        pressedStart = true;
        Layout.ToggleLogo(true);
        Layout.DisableMenu();
        StateHasChanged();
    }

    public async void SetBalancedBuild()
    {
        Player.SetStats(100, 70, 60, 70, 70, 60);
        choseBuild = true;
        build = "bal";
    }

    public async void SetAgileBuild()
    {
        Player.SetStats(100, 90, 50, 50, 70, 80);
        choseBuild = true;
        build = "agi";
    }

    public async void SetTankyBuild()
    {
        Player.SetStats(100, 40, 90, 100, 40, 30);
        choseBuild = true;
        build = "tnk";
    }

    public void Submit()
    {
        if (enteredName && enteredTagline && choseBuild)
        {
            Game.SetUp(Player);
            Navigation.NavigateTo("/battle");
        }
    }
}
