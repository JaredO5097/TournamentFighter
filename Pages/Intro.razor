@page "/"
@inherits MainLayout
@inject Game Game
@inject NavigationManager Navigation

<PageTitle>Tournament Fighter</PageTitle>

@if (enabledMusic)
{
    <!--<audio id="menu" autoplay src="@menuMusicSrc"></audio>-->
}

@if (pressedStart)
{
    <EditForm class="col-start full-h" EditContext=@editContext Model=@Player OnValidSubmit=@Submit>
        <DataAnnotationsValidator></DataAnnotationsValidator>
        <div class="d-plain intro-15 row-center h-15">
            <p>Your name is &nbsp;</p>
            <div class="col-start text-input">
                <!--<ValidationMessage For="() => Player.Name"></ValidationMessage>-->
                <InputText tabindex="1" placeholder="type here..."
                           @bind-Value=@Player.Name @ref="nameInput"></InputText>
            </div>
            @{
                enteredName = enteredTagline = !String.IsNullOrWhiteSpace(Player.Name);
            }
        </div>
        @if (enteredName)
        {
            <p class="d-plain intro-10 h-10">and you've entered a fighting tournament.</p>

            <div class="d-plain intro-10 row-center h-10">
                <p>You want people to call you the &nbsp</p>
                <div class="col-start text-input">
                    <!--<ValidationMessage For="() => Player.Tagline"></ValidationMessage>-->
                    <InputText tabindex="2" placeholder="type here..."
                               @bind-Value=@Player.Tagline @ref="taglineInput"></InputText>
                </div>
                @{
                    enteredTagline = !String.IsNullOrWhiteSpace(Player.Tagline);
                }
            </div>
        }
        @if (enteredTagline)
        {
            <p class="d-plain intro-10 h-10">You will be facing 3 opponents. Defeat all three and you'll win prize money and fame!</p>
            <div class="d-plain intro-20 col-start h-20">
                <p>You've been training hard, and your fighting style is:</p>
                <div class="row-center">
                    <button class="btn-gold btn-xsmall" type="button" @onclick=@SetBalancedBuild>Balanced</button>
                    <button class="btn-gold btn-xsmall" type="button" @onclick=@SetAgileBuild>Agile</button>
                    <button class="btn-gold btn-xsmall" type="button" @onclick=@SetTankyBuild>Tanky</button>
                </div>
                @if (choseBuild)
                {
                    <button class="btn-gold btn-small" type="submit">Submit</button>
                }
            </div>
        }
    </EditForm>
}
else
{
    <span>
        <h1 class="logo">TOURNAMENT</h1>
        <h1 class="logo logo-bottom">FIGHTER</h1>
    </span>
    <button id="start-btn" class="btn-gold btn-large" @onclick=@StartIntro>Start</button>
    <!--<div class="btn-wrap"></div>-->
    <!--<button class="btn-gold btn-small" @onclick=@(() => {enabledMusic = !enabledMusic;})>MUSIC</button>-->
}

@code {
    private Character Player = new Character();

    private InputText nameInput;
    private InputText taglineInput;
    private InputText victoryInput;
    private InputText defeatInput;

    private EditContext? editContext { get; set; }
    private bool pressedStart = false;
    private bool enteredName = false;
    private bool enteredTagline = false;
    private bool choseBuild = false;

    private bool enabledMusic = false;
    private string menuMusicSrc = "media/menu.wav";

    private int maxNameLength = 20;
    private int maxTaglineLength = 20;

    [CascadingParameter] public MainLayout Layout { get; set; }

    protected override void OnInitialized()
    {
        Layout.ToggleLogo(false);
        Layout.DisableMenu();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (pressedStart)
        {
            if (!enteredName)
            {
                editContext?.Validate();
                if (nameInput.Element.HasValue)
                {
                    await nameInput.Element.Value.FocusAsync();
                }
            }
            else if (!enteredTagline)
            {
                if (taglineInput.Element.HasValue)
                {
                    await taglineInput.Element.Value.FocusAsync();
                }
            }
        }
    }

    private void StartIntro()
    {
        pressedStart = true;
        Layout.ToggleLogo(true);
        Layout.DisableMenu();
        StateHasChanged();
    }

    public void SetBalancedBuild()
    {
        Player.SetStats(70, 70, 60, 70, 70, 60);
        choseBuild = true;
    }

    public void SetAgileBuild()
    {
        Player.SetStats(60, 90, 50, 50, 70, 80);
        choseBuild = true;
    }

    public void SetTankyBuild()
    {
        Player.SetStats(100, 40, 90, 100, 40, 30);
        choseBuild = true;
    }

    public void Submit()
    {
        if (enteredName && enteredTagline && choseBuild)
        {
            Game.SetUp(Player);
            Navigation.NavigateTo("/battle");
        }
    }
}
